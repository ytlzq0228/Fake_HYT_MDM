<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Device Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>Registered Devices</h1>
    <div class="device-grid">
        {% for device_id, entry in devices.items() %}
        <div class="device-card">
            <h2>{{ entry.deviceInfo.wholeInfo.alias if entry.deviceInfo and entry.deviceInfo.wholeInfo else device_id }}</h2>
{% set last_update = now - entry.update_time %}
<p>
  {% if last_update > 600 %}
    <strong>Last Update:</strong>
    <span style="background-color: red; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px;">
      {{ last_update }}s ago — Offline
    </span>
  {% else %}
    <strong>Last Update:</strong>
    <span style="background-color: green; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px;">
      {{ last_update }}s ago — Online
    </span>
  {% endif %}
</p>
            <p><strong>Device ID:</strong> {{ device_id }}</p>
            <p><strong>Model:</strong> {{ entry.modelName or "N/A" }}</p>
            <!--<p><strong>SN:</strong> {{ entry.sn or "N/A" }}</p>-->
            <p><strong>Version:</strong> {{ entry.versionCode or "N/A" }}</p>

            {% if entry.deviceInfo %}
                {% set bb = entry.deviceInfo.bbInfo %}
                {% set whole = entry.deviceInfo.wholeInfo %}

                <p><strong>Android:</strong> {{ bb.androidVersion }}</p>
                <p><strong>CPU:</strong> {{ bb.cpuModel }}</p>
                <p><strong>IP:</strong> {{ bb.ip }}</p>
                <p><strong>MAC:</strong> {{ bb.mac }}</p>

                <div class="bar-group">
                    <label>RAM Usage ({{ bb.ramUsage }} / {{ bb.ramTotal }} MB)</label>
                    <progress value="{{ bb.ramUsage }}" max="{{ bb.ramTotal }}"></progress>
                </div>

                <div class="bar-group">
                    <label>ROM Usage ({{ bb.romUsage }} / {{ bb.romTotal }} MB)</label>
                    <progress value="{{ bb.romUsage }}" max="{{ bb.romTotal }}"></progress>
                </div>

                <div class="bar-group">
                    <label>
                        Battery Level ({{ whole.batteryLevel }}%)
                        {% if whole.batteryStatus == 5 %}
                            - FULL-5
                        {% elif whole.batteryStatus == 4 %}
                            - Charging-4
                        {% elif whole.batteryStatus == 3 %}
                            - Not Charge-3
                        {% elif whole.batteryStatus == 2 %}
                            - Charging-2
                        {% else %}
                            - STATUS {{whole.batteryStatus}}
                        {% endif %}
                    </label>
                    <progress value="{{ whole.batteryLevel }}" max="100"></progress>
                </div>
                <!--
                <div class="bar-group">
                    <label>Battery Level ({{ whole.batteryLevel }}%)</label>
                    <progress value="{{ whole.batteryLevel }}" max="100"></progress>
                </div>
                -->
                <p><strong>VPN Support:</strong> {{ "Yes" if bb.vpn else "No" }}</p>
                <p><strong>Hotspot Support:</strong> {{ "Yes" if bb.personalHotSpot else "No" }}</p>
                <p><strong>Signal Level:</strong> {{ bb.signalLevel }} dBm</p>
            {% endif %}

            {% if entry.location %}
              <p>
                Location: {{ entry.location.latitude }},{{ entry.location.longitude }}<br>
                Last Update Location {{ now - entry.location.update_time }} seconds before<br>
                <a href="https://www.google.com/maps?q={{ entry.location.latitude }},{{ entry.location.longitude }}" target="_blank">
                  View on Google Maps
                </a><br>
                APRS SSID: 
                <a href="https://aprs.fi/#!call=a%2F{{ entry.location.aprs_ssid }}" target="_blank">
                  {{ entry.location.aprs_ssid }}
                </a><br>
              </p>
              {% set lat = entry.location.latitude | float %}
              {% set lon = entry.location.longitude | float %}
              {% set dx = 5 %}
              {% set dy = 5 %}
              <iframe
                width="100%"
                height="300"
                frameborder="0"
                scrolling="no"
                marginheight="0"
                marginwidth="0"
                style="border: 1px solid #ccc; border-radius: 8px;"
                src="https://www.openstreetmap.org/export/embed.html?bbox={{ lon - dx }}%2C{{ lat - dy }}%2C{{ lon + dx }}%2C{{ lat + dy }}&layer=mapnik&marker={{ lat }}%2C{{ lon }}">
              </iframe>
              <br/>
              <small>
                <a href="https://www.openstreetmap.org/?mlat={{ entry.location.latitude }}&mlon={{ entry.location.longitude }}#map=15/{{ entry.location.latitude }}/{{ entry.location.longitude }}" target="_blank">
                  在 OpenStreetMap 上查看大图
                </a>
              </small>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</body>
</html>